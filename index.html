<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pilote Tréso GIA - Privé</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script type="importmap">
      {
        "imports": {
          "react": "https://esm.sh/react@18.2.0",
          "react-dom": "https://esm.sh/react-dom@18.2.0",
          "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
          "recharts": "https://esm.sh/recharts@2.12.2?external=react,react-dom",
          "lucide-react": "https://esm.sh/lucide-react@0.344.0?external=react,react-dom",
          "firebase/app": "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js",
          "firebase/auth": "https://www.gstatic.com/firebasejs/10.8.1/firebase-auth.js",
          "firebase/firestore": "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js"
        }
      }
    </script>
    
    <style>
        body { background-color: #020617; color: #cbd5e1; font-size: 0.9rem; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }
        
        .animate-in { animation: animateIn 0.2s ease-out forwards; }
        @keyframes animateIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        
        /* Custom Range Slider Styling */
        input[type=range] {
            -webkit-appearance: none; 
            background: transparent; 
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 18px;
            width: 18px;
            border-radius: 50%;
            background: #f97316; /* Orange-500 */
            cursor: pointer;
            margin-top: -7px; 
            border: 2px solid #fff;
            box-shadow: 0 0 10px rgba(249, 115, 22, 0.5);
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: #334155; /* Slate-700 */
            border-radius: 2px;
        }
        input[type=range]:focus {
            outline: none;
        }
        
        .toggle-checkbox:checked {
            right: 0;
            border-color: #10b981;
        }
        .toggle-checkbox:checked + .toggle-label {
            background-color: #10b981;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="module">
        import React, { useState, useEffect, useMemo, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { AreaChart, Area, ComposedChart, BarChart, Bar, Line, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, Cell, ReferenceLine, Legend, ReferenceArea } from 'recharts';
        import { 
            ArrowUpRight, ArrowDownRight, Wallet, Settings, Trash2, Info, 
            Repeat, Layers, Scale, Calculator, Filter, Cloud, CheckCircle, 
            Loader2, LogOut, ShieldCheck, Lock, User, XCircle, Percent, BarChart3, CalendarClock, AlertTriangle, Check, Banknote, List, Eye, PiggyBank, BookOpen, X, Pencil, Undo2, History, TrendingUp, Shield, Siren, Target, ChevronDown, ChevronUp, ToggleLeft, ToggleRight, Clock, Info as InfoIcon
        } from 'lucide-react';
        
        import { initializeApp } from 'firebase/app';
        import { 
            getAuth, onAuthStateChanged, signInWithPopup, 
            GoogleAuthProvider, signOut 
        } from 'firebase/auth';
        import { 
            getFirestore, collection, doc, setDoc, deleteDoc, 
            onSnapshot, query, getDocs, where, writeBatch
        } from 'firebase/firestore';

        // --- SÉCURITÉ ---
        const ADMIN_EMAIL = "fradaoud@gmail.com";

        // --- CONFIGURATION FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyA0l9XI6mVfPW-HYvgu_ygA8Xrxyu41NPk", 
            authDomain: "compta-68499.firebaseapp.com",
            projectId: "compta-68499",
            storageBucket: "compta-68499.firebasestorage.app",
            messagingSenderId: "102037621816",
            appId: "1:102037621816:web:46c5026bf2f458f678aacd"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = firebaseConfig.projectId; 

        // --- UI UTILS ---
        const Card = ({ children, className = "", onClick }) => React.createElement('div', { onClick, className: `bg-slate-900 rounded-xl shadow-lg border border-slate-800 ${className}` }, children);
        
        const Button = ({ children, onClick, variant = "primary", className = "", type = "button", disabled = false, title = "" }) => {
            const baseStyle = "px-3 py-1.5 rounded-lg font-medium transition-all duration-200 flex items-center justify-center gap-2 active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed text-sm";
            const variants = {
                primary: "bg-indigo-600 text-white hover:bg-indigo-500 shadow-lg shadow-indigo-900/20",
                secondary: "bg-slate-800 text-slate-300 border border-slate-700 hover:bg-slate-700 hover:text-white",
                danger: "bg-red-900/20 text-red-400 hover:bg-red-900/40 border border-red-900/50",
                adjustment: "bg-purple-600 text-white hover:bg-purple-500 shadow-lg shadow-purple-900/20",
                google: "bg-white text-slate-700 hover:bg-slate-50 shadow-md",
                success: "bg-emerald-600 text-white hover:bg-emerald-500 shadow-lg shadow-emerald-900/20",
                warning: "bg-orange-600 text-white hover:bg-orange-500 shadow-lg shadow-orange-900/20"
            };
            return React.createElement('button', { type, onClick, disabled, title, className: `${baseStyle} ${variants[variant]} ${className}` }, children);
        };

        const formatEuro = (v) => new Intl.NumberFormat('fr-FR', { style: 'currency', currency: 'EUR', maximumFractionDigits: 0 }).format(v);
        const formatEuroDec = (v) => new Intl.NumberFormat('fr-FR', { style: 'currency', currency: 'EUR', maximumFractionDigits: 2 }).format(v);

        // --- CHART COMPONENTS ---
        const CustomSalaryDot = (props) => {
            const { cx, cy, payload } = props;
            if (payload && payload.isPayDay && payload.soldeWithSalary !== null) {
                return React.createElement('circle', { cx, cy, r: 5, fill: "#f97316", stroke: "white", strokeWidth: 2 });
            }
            return null;
        };

        // --- ECRANS ---
        const UnauthorizedScreen = ({ onLogout, email }) => {
            return React.createElement('div', { className: "min-h-screen bg-slate-950 flex flex-col items-center justify-center p-4 text-center" },
                React.createElement(XCircle, { size: 64, className: "text-red-500 mb-4" }),
                React.createElement('h1', { className: "text-2xl font-bold text-white mb-2" }, "Accès Refusé"),
                React.createElement('p', { className: "text-slate-400 max-w-md mb-6" }, `Le compte ${email} n'est pas autorisé.`),
                React.createElement(Button, { variant: "danger", onClick: onLogout }, "Se déconnecter")
            );
        };

        const LoginScreen = ({ onLogin, loading }) => {
            const [error, setError] = useState("");
            const handleLoginClick = async () => { setError(""); try { await onLogin(); } catch (e) { setError(e.message || "Erreur de connexion"); } };

            return React.createElement('div', { className: "min-h-screen bg-slate-950 flex flex-col items-center justify-center p-4 relative overflow-hidden" },
                React.createElement('div', { className: "absolute top-1/4 left-1/4 w-64 h-64 bg-indigo-600/10 rounded-full blur-3xl" }),
                React.createElement('div', { className: "absolute bottom-1/4 right-1/4 w-64 h-64 bg-purple-600/10 rounded-full blur-3xl" }),
                React.createElement('div', { className: "relative z-10 max-w-md w-full bg-slate-900 p-8 rounded-2xl border border-slate-800 shadow-2xl flex flex-col items-center text-center space-y-6" },
                    React.createElement('div', { className: "w-16 h-16 bg-slate-800 rounded-full flex items-center justify-center mb-2 shadow-inner" }, React.createElement(Lock, { size: 32, className: "text-indigo-500" }) ),
                    React.createElement('div', {}, React.createElement('h1', { className: "text-2xl font-bold text-white mb-2" }, "Coffre-fort GIA"), React.createElement('p', { className: "text-slate-400 text-sm" }, "Espace privé et sécurisé.") ),
                    error && React.createElement('div', { className: "w-full p-3 bg-red-900/30 border border-red-800 rounded-lg text-red-300 text-xs" }, error),
                    React.createElement('div', { className: "w-full pt-4 border-t border-slate-800" }, React.createElement(Button, { variant: "google", onClick: handleLoginClick, className: "w-full py-3", disabled: loading }, loading ? React.createElement(Loader2, { size: 20, className: "animate-spin text-slate-600" }) : "S'identifier avec Google") )
                )
            );
        };

        const DocumentationModal = ({ onClose }) => {
            return React.createElement('div', { className: "fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4 backdrop-blur-sm" },
                React.createElement('div', { className: "bg-slate-900 border border-slate-700 rounded-2xl max-w-lg w-full p-6 shadow-2xl relative animate-in" },
                    React.createElement('button', { onClick: onClose, className: "absolute top-4 right-4 text-slate-400 hover:text-white" }, React.createElement(X, { size: 20 })),
                    React.createElement('h2', { className: "text-xl font-bold text-white mb-4 flex items-center gap-2" }, React.createElement(BookOpen, { className: "text-indigo-400" }), "Règles de Gestion GIA"),
                    React.createElement('div', { className: "space-y-4 text-sm text-slate-300" },
                        React.createElement('div', { className: "p-3 bg-purple-900/20 border border-purple-900/50 rounded-lg" },
                            React.createElement('h3', { className: "font-bold text-purple-300 mb-1" }, "⚡️ Règle d'Or : Paiement des Charges"),
                            React.createElement('p', {}, "NE JAMAIS saisir le paiement de la TVA ou de l'URSSAF comme une 'Sortie' standard."),
                            React.createElement('p', { className: "mt-2 text-xs text-slate-400" }, "Utilise le bouton ", React.createElement('span', { className: "font-bold text-purple-400" }, "Régul"), " et indique un montant négatif."),
                        ),
                    ),
                    React.createElement('div', { className: "mt-6 pt-4 border-t border-slate-800 flex justify-end" }, React.createElement(Button, { variant: "secondary", onClick: onClose }, "Compris") )
                )
            );
        };
        
        // Helper to calculate line tax
        const calculateLineTaxHelper = (t, tvaRate, urssafRate) => {
             const amt = parseFloat(t.amount || 0); 
             const comm = parseFloat(t.commission || 0);
             if(t.type === 'adjustment') return { net: amt - (t.adjUrssaf||0), urssaf: t.adjUrssaf||0, tvaNet: t.adjTva||0, bank: amt }; 
             if(t.type === 'income') { 
                 let ht = amt, tva = 0, urssaf = 0; 
                 if(t.tvaRate > 0) { ht = amt / (1 + t.tvaRate/100); tva = amt - ht; } 
                 if(t.urssafRate > 0) urssaf = ht * (t.urssafRate/100); 
                 const net = ht - urssaf - comm; const bank = amt - comm;
                 return { net, urssaf, tvaNet: tva, bank }; 
             } else { 
                 let ht = amt, tva = 0; 
                 if(t.tvaRate > 0) { ht = amt / (1 + t.tvaRate/100); tva = amt - ht; } 
                 return { net: 0, urssaf: 0, tvaNet: -tva, bank: -amt }; 
             } 
        };

        // --- REMUNERATION ADVISOR ---
        const RemunerationAdvisor = ({ stats, settings, transactions, simulatedSalary, setSimulatedSalary, simulationDuration, setSimulationDuration, isSimulationEnabled, setIsSimulationEnabled, onSettingsChange }) => {
            const [isExpanded, setIsExpanded] = useState(false);
            
            // 1. Données de base
            const currentBank = stats.currentBank; 
            const minProj = stats.minProjectedUntilPayday; 
            const liability = stats.totalTaxLiability; 
            const trueAvailableCash = Math.min(currentBank, minProj);

            // 2. Calcul des charges prévues
            const monthlyExpenses = stats.projectedMonthlyExpenses; 
            
            // Récupérer le détail des charges pour l'explication
            const today = new Date();
            const todayStr = today.toISOString().split('T')[0];
            const horizonDate = new Date(today);
            horizonDate.setMonth(horizonDate.getMonth() + simulationDuration);
            const horizonStr = horizonDate.toISOString().split('T')[0];
            
            const projectedExpensesList = transactions
                .filter(t => t.type === 'expense' && !t.validated && t.date >= todayStr && t.date <= horizonStr);
            
             // Calcul de la somme EXACTE des charges prévues (HT pour impact Net)
            let realExpensesSum = 0;
            projectedExpensesList.forEach(t => {
                 const tax = calculateLineTaxHelper(t);
                 // Coût pour le Net = Bank (TTC) - TVA Récup
                 // Bank est negatif (ex -1200), tvaNet est negatif (ex -200). 
                 // Bank - tvaNet = -1200 - (-200) = -1000.
                 realExpensesSum += Math.abs(tax.bank - tax.tvaNet);
            });

            const totalMonthlyBurn = simulatedSalary + monthlyExpenses; 
            const monthsOfSecurity = simulationDuration;
            const requiredBuffer = (totalMonthlyBurn * monthsOfSecurity) + liability;
            const availableForWithdraw = trueAvailableCash - requiredBuffer;

            const payDate = new Date(today.getFullYear(), today.getMonth(), 26);
            if (today.getDate() >= 26) payDate.setMonth(payDate.getMonth() + 1);
            const dateStr = payDate.toLocaleDateString('fr-FR', {day:'numeric', month:'long'});

            // Helper sales needed
            const tvaRate = parseFloat(settings.defaultTvaRate || 20);
            const urssafRate = parseFloat(settings.defaultUrssafRate || 22);
            const ratioHT = 1 / (1 + tvaRate/100);
            const taxPart = (1 - ratioHT) + (ratioHT * (urssafRate/100));
            const netRatio = 1 - taxPart;
            
            // Projection temporelle
            const futureTxs = transactions.filter(t => !t.validated && t.date >= todayStr && t.date <= horizonStr).sort((a,b) => new Date(a.date) - new Date(b.date));
            
            const payDates = [];
            let d = new Date(today);
            if (d.getDate() >= 26) d.setMonth(d.getMonth() + 1);
            d.setDate(26);
            while(d <= horizonDate) {
                payDates.push(d.toISOString().split('T')[0]);
                d.setMonth(d.getMonth() + 1);
            }
            const nbSalaires = payDates.length;
            const totalSalaryCost = simulatedSalary * nbSalaires;
            
            let runningNet = stats.currentNetPocket;
            let minProjectedNet = stats.currentNetPocket;
            let lowPointDate = todayStr;
            
            const events = [
                ...futureTxs.map(t => {
                    const tax = calculateLineTaxHelper(t);
                    // CORRECTION : Impact Net des dépenses = HT
                    const flow = t.type === 'income' ? tax.net : (tax.bank - tax.tvaNet);
                    return { date: t.date, amount: flow, type: 'tx' };
                }),
                ...payDates.map(date => ({ date: date, amount: -simulatedSalary, type: 'salary' }))
            ].sort((a,b) => new Date(a.date) - new Date(b.date));
            
            events.forEach(e => {
                runningNet += e.amount;
                if (runningNet < minProjectedNet) {
                    minProjectedNet = runningNet;
                    lowPointDate = e.date;
                }
            });

            // Status Logic
            // Besoin VITAL : Tout payer sur la période (charges + salaires) sans passer en négatif
            // Si minProjectedNet < 0, ça veut dire qu'on a pas assez de Net initial pour couvrir les sorties nettes.
            const isSurvivalMode = minProjectedNet < 0;

            // Calcul Manques
            const missingForSurvival = isSurvivalMode ? Math.abs(minProjectedNet) : 0;

            // Besoin Confort : Avoir X mois d'avance A LA FIN
            // "Remplir le coussin" = Avoir (Salaire + Charges Moyennes) * Durée en Net Dispo à la fin.
            // On veut que le Net Dispo ne descende jamais en dessous du coussin ? Non, c'est trop dur.
            // On veut que le Net Dispo FINAL (ou min) permette de constituer cette réserve.
            // Disons : Objectif = Avoir le coussin plein.
            // Manque = Coussin - (Ce qu'il me reste).
            // Si je suis en survie (négatif), il me manque (Déficit + Coussin).
            // Si je suis positif, il me manque (Coussin - Reste).
            
            // Cible de réserve de sécurité (NET)
            // On prend les charges RÉELLES détectées pour la période comme base, ou la moyenne si pas de charges ?
            // Restons sur (Salaire + Moyenne Charges) * Durée pour la cible théorique.
            const safetyTargetNet = (simulatedSalary + stats.averageExpense) * simulationDuration;
            
            // Reste effectif (le point le plus bas est le "vrai" reste disponible le pire jour)
            const effectiveRemaining = Math.max(0, minProjectedNet);
            
            const missingForComfort = Math.max(0, safetyTargetNet - effectiveRemaining);
            
            const totalMissingNet = missingForSurvival + missingForComfort;

            const salesNeededForSurvival = missingForSurvival / netRatio;
            const salesNeededForComfort = missingForComfort / netRatio;
            const totalSalesNeededTTC = totalMissingNet / netRatio;
            
            const isEatingBuffer = !isSurvivalMode && missingForComfort > 0;

            const getStatusColor = () => {
                if (isSurvivalMode) return "text-rose-500";
                if (isEatingBuffer) return "text-orange-500";
                return "text-emerald-400";
            };

            const getStatusText = () => {
                if (isSurvivalMode) return "DANGER (Net Négatif)";
                if (isEatingBuffer) return "SÉCURITÉ ENTAMÉE";
                return "SÉCURISÉ (Réserve intacte)";
            };
            
            const toggleSimulation = (e) => {
                e.stopPropagation();
                setIsSimulationEnabled(!isSimulationEnabled);
                if (!isSimulationEnabled) setIsExpanded(true);
            };
            
            const handleSalaryChange = (e) => { const val = parseInt(e.target.value); setSimulatedSalary(val); onSettingsChange({ simulatedSalary: val }); };
            const handleDurationChange = (e) => { const val = parseInt(e.target.value); setSimulationDuration(val); onSettingsChange({ simulationDuration: val }); };
            
            // Top dépenses pour explication
            const topExpensesList = projectedExpensesList
                .sort((a,b) => b.amount - a.amount)
                .slice(0, 3);

            return React.createElement(Card, { className: `transition-all duration-300 overflow-hidden relative ${isExpanded ? 'p-4' : 'p-2 cursor-pointer hover:bg-slate-800'} ${isSurvivalMode ? 'border-rose-900/50' : isEatingBuffer ? 'border-orange-500/30' : 'border-indigo-500/30'}`, onClick: !isExpanded ? () => setIsExpanded(true) : undefined },
                
                 React.createElement('div', { className: "flex justify-between items-center" },
                    React.createElement('div', { className: "flex items-center gap-3" },
                        React.createElement('div', { className: `p-2 rounded-lg ${isSurvivalMode ? 'bg-rose-900/20 text-rose-400' : 'bg-emerald-900/20 text-emerald-400'}` }, React.createElement(Wallet, { size: 20 })),
                        React.createElement('div', {},
                            React.createElement('h3', { className: "font-bold text-white text-sm flex items-center gap-2" }, 
                                "Assistant Rémunération",
                                !isExpanded && isSimulationEnabled && React.createElement('span', { className: `text-xs font-normal px-2 py-0.5 rounded-full bg-slate-900 border border-slate-700 ${getStatusColor()}` }, `${formatEuro(simulatedSalary)} • ${isSurvivalMode ? 'Manque Cash' : 'OK'}`)
                            ),
                            isExpanded && React.createElement('span', { className: "text-xs text-slate-500 block" }, `Projection sur ${simulationDuration} mois`)
                        )
                    ),
                    React.createElement('div', { className: "flex items-center gap-2" },
                        React.createElement('button', { 
                             onClick: toggleSimulation,
                             className: `flex items-center gap-1 text-xs font-bold px-2 py-1 rounded border transition-all ${isSimulationEnabled ? 'bg-indigo-600 border-indigo-500 text-white' : 'bg-slate-900 border-slate-700 text-slate-500'}`
                        }, isSimulationEnabled ? "Simulation ON" : "Simulation OFF", isSimulationEnabled ? React.createElement(ToggleRight, {size:16}) : React.createElement(ToggleLeft, {size:16})),

                        isExpanded ? 
                            React.createElement(Button, { variant: "secondary", onClick: (e) => { e.stopPropagation(); setIsExpanded(false); }, className: "!p-1 !h-8 !w-8 rounded-full" }, React.createElement(ChevronUp, {size:16})) :
                            React.createElement(ChevronDown, { size: 16, className: "text-slate-500" })
                    )
                ),

                isExpanded && isSimulationEnabled && React.createElement('div', { className: "mt-4 animate-in space-y-6" },
                    
                    // CONTROLS
                    React.createElement('div', { className: "flex flex-col gap-4 bg-slate-950/50 p-4 rounded-xl border border-slate-800" },
                        React.createElement('div', {},
                            React.createElement('div', { className: "flex justify-between text-xs text-slate-400 mb-2 font-medium" },
                                React.createElement('span', {}, "Salaire souhaité"),
                                React.createElement('span', { className: "text-orange-400 font-bold text-lg" }, formatEuro(simulatedSalary))
                            ),
                            React.createElement('div', { className: "flex items-center gap-3" },
                                React.createElement('span', { className: "text-[10px] text-slate-500" }, "1500 €"),
                                React.createElement('input', { type: "range", min: "1500", max: "6000", step: "100", value: simulatedSalary, onChange: handleSalaryChange, className: "flex-1 h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-orange-500" }),
                                React.createElement('span', { className: "text-[10px] text-slate-500" }, "6000 €")
                            )
                        ),
                        React.createElement('div', { className: "pt-4 border-t border-slate-800/50" },
                            React.createElement('div', { className: "flex justify-between text-xs text-slate-400 mb-2 font-medium" },
                                React.createElement('span', { className: "flex items-center gap-1" }, React.createElement(Shield, {size:14}), "Durée de test (Projection)"),
                                React.createElement('span', { className: "text-indigo-400 font-bold text-lg" }, `${simulationDuration} mois`)
                            ),
                             React.createElement('div', { className: "flex items-center gap-3" },
                                React.createElement('span', { className: "text-[10px] text-slate-500" }, "1 mois"),
                                React.createElement('input', { type: "range", min: "1", max: "10", step: "1", value: simulationDuration, onChange: handleDurationChange, className: "flex-1 h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-indigo-500" }),
                                React.createElement('span', { className: "text-[10px] text-slate-500" }, "10 mois")
                            )
                        )
                    ),

                    // RESULTAT CENTRAL
                    React.createElement('div', { className: "text-center py-2 relative" },
                        React.createElement('div', { className: "text-slate-400 text-xs uppercase font-bold tracking-wider mb-1" }, "Verdict de la Projection"),
                        React.createElement('div', { className: `text-3xl font-black ${getStatusColor()}` }, getStatusText()),
                        
                        React.createElement('div', { className: "mt-3 max-w-lg mx-auto" },
                            isSurvivalMode ? 
                                React.createElement('div', { className: "bg-rose-950/50 border border-rose-500/50 rounded-lg p-3 text-xs text-rose-200" }, 
                                    React.createElement('div', { className: "flex items-center justify-center gap-2 font-bold mb-2 text-sm" }, React.createElement(Siren, {size:16}), "DÉFICIT IMMÉDIAT"),
                                    React.createElement('div', { className: "mb-2" }, `Tes ressources (Net Dispo ${formatEuro(stats.currentNetPocket)}) ne suffisent pas pour payer tes charges futures (${formatEuro(realExpensesSum)}) et tes salaires (${formatEuro(totalSalaryCost)}).`),
                                ) :
                            isEatingBufferNet ? 
                                React.createElement('div', { className: "bg-orange-950/50 border border-orange-500/30 rounded-lg p-3 text-xs text-orange-200" }, 
                                    React.createElement('div', { className: "flex items-center justify-center gap-2 font-bold mb-1" }, React.createElement(Shield, {size:14}), "SÉCURITÉ ENTAMÉE"),
                                    `Tu couvres tes frais, mais tu n'as pas les ${simulationDuration} mois de réserve complets (${formatEuro(safetyTargetNet)}).`
                                ) :
                                React.createElement('div', { className: "bg-emerald-950/50 border border-emerald-500/30 rounded-lg p-3 text-xs text-emerald-200" }, 
                                    React.createElement('div', { className: "flex items-center justify-center gap-2 font-bold mb-2 text-sm" }, React.createElement(Check, {size:16}), "C'EST BON POUR LA SURVIE"),
                                    React.createElement('div', {}, `Ton Net Dispo couvre toutes tes charges prévues (${formatEuro(realExpensesSum)}) et tes salaires (${formatEuro(totalSalaryCost)}) sur ${simulationDuration} mois.`),
                                    React.createElement('div', { className: "mt-1 font-bold" }, `Marge restante : ${formatEuro(effectiveRemaining)}`)
                                )
                        )
                    ),

                    // LISTE DES COUPABLES (Si charges élevées)
                    realExpensesSum > 0 && React.createElement('div', { className: "mt-2 bg-slate-950/50 p-2 rounded border border-slate-800" },
                         React.createElement('div', { className: "text-[10px] text-slate-500 uppercase font-bold mb-2" }, `Dépenses prévues détectées (${simulationDuration} mois, HT)`),
                         React.createElement('ul', { className: "space-y-1 text-xs" },
                            topExpensesList.map(tx => {
                                const costHT = Math.abs(calculateLineTaxHelper(tx).bank - calculateLineTaxHelper(tx).tvaNet);
                                return React.createElement('li', { key: tx.id, className: "flex justify-between text-slate-400 border-b border-slate-800/50 pb-1 last:border-0" },
                                    React.createElement('span', {className: "truncate mr-2"}, `${tx.title} (${new Date(tx.date).toLocaleDateString('fr-FR', {day:'numeric', month:'short'})})`),
                                    React.createElement('span', { className: "text-slate-200 whitespace-nowrap" }, formatEuroDec(costHT))
                                );
                            })
                        )
                    ),
                    
                    // LIGNE CA À RENTRER
                    (salesNeededForSurvival > 0 || salesNeededForComfort > 0) && React.createElement('div', { className: "mt-3 pt-3 border-t border-slate-700/50 flex flex-col gap-2 text-xs text-slate-400 bg-slate-900/30 p-3 rounded" },
                        React.createElement('div', { className: "flex items-center gap-2 font-bold text-slate-300" },
                             React.createElement(Target, {size:16, className: "text-indigo-400"}),
                             "Objectif de Ventes (TTC) pour..."
                        ),
                        salesNeededForSurvival > 0 && React.createElement('div', { className: "flex justify-between pl-6" },
                            React.createElement('span', { className: "text-rose-300" }, "...éviter le découvert (Survie) :"),
                            React.createElement('span', { className: "font-bold text-rose-400" }, formatEuro(salesNeededForSurvival))
                        ),
                        salesNeededForComfort > 0 && React.createElement('div', { className: "flex justify-between pl-6" },
                            React.createElement('span', { className: "text-orange-300" }, `...remplir la réserve (${simulationDuration} mois) :`),
                            React.createElement('span', { className: "font-bold text-orange-400" }, formatEuro(salesNeededForComfort))
                        ),
                        React.createElement('div', { className: "flex justify-between pl-6 pt-1 border-t border-slate-700/30 mt-1 font-bold" },
                            React.createElement('span', {}, "TOTAL à encaisser :"),
                            React.createElement('span', { className: "text-indigo-300 text-sm" }, formatEuro(totalSalesNeededTTC))
                        )
                    )
                ),
                isExpanded && !isSimulationEnabled && React.createElement('div', { className: "mt-4 p-4 text-center text-slate-500 text-sm italic" },
                     "Activez la simulation pour voir les projections."
                )
            );
        };

        // --- SIMULATION PANEL ---
        const SimulationPanel = ({ formData, transactions, editingId }) => {
             const unitAmt = parseFloat(formData.amount || 0);
            const unitComm = parseFloat(formData.commission || 0);
            if (unitAmt === 0) return null;
            const isSplit = formData.type === 'income' && formData.isSplitPayment;
            const splitCount = parseInt(formData.splitCount || 1);
            const totalAmt = isSplit ? unitAmt * splitCount : unitAmt;
            const totalComm = isSplit ? unitComm * splitCount : unitComm;
            let ht = totalAmt, tvaAmount = 0, urssafAmount = 0;
            if (formData.type === 'income') {
                if (formData.hasTvaIncome) { ht = totalAmt / (1 + parseFloat(formData.customTvaRateIncome || 0) / 100); tvaAmount = totalAmt - ht; }
                if (formData.hasUrssaf) { urssafAmount = ht * (parseFloat(formData.customUrssafRate || 0) / 100); }
            } else if (formData.type === 'expense') {
                 if (formData.hasTvaExpense) { ht = totalAmt / (1 + parseFloat(formData.customTvaRateExpense || 0) / 100); tvaAmount = totalAmt - ht; }
            }
            const netPocket = ht - urssafAmount - totalComm;
            const totalTax = tvaAmount + urssafAmount;
            const monthlyGross = unitAmt; 
            const netPerMonth = netPocket / splitCount;
            let remainingGroupStats = null;
            if (editingId && transactions) {
                const currentTx = transactions.find(t => t.id === editingId);
                if (currentTx && currentTx.groupId) {
                    const groupTxs = transactions.filter(t => t.groupId === currentTx.groupId && t.date >= currentTx.date);
                    if (groupTxs.length > 0) {
                        let remGross = 0, remNet = 0;
                        groupTxs.forEach(t => {
                            const isCurrent = t.id === editingId;
                            const amt = isCurrent ? unitAmt : t.amount;
                            const comm = isCurrent ? unitComm : t.commission;
                            let lineHt = amt;
                            let lineTax = 0;
                            if (formData.type === 'income') {
                                if (formData.hasTvaIncome) { lineHt = amt / (1 + parseFloat(formData.customTvaRateIncome)/100); }
                                if (formData.hasUrssaf) { lineTax = lineHt * (parseFloat(formData.customUrssafRate)/100); }
                                if (formData.hasTvaIncome) { lineTax += (amt - lineHt); }
                            }
                            remGross += amt;
                            remNet += (lineHt - (formData.hasUrssaf ? lineHt * (parseFloat(formData.customUrssafRate)/100) : 0) - comm);
                        });
                        remainingGroupStats = { count: groupTxs.length, gross: remGross, net: remNet };
                    }
                }
            }
            return React.createElement('div', { className: "bg-slate-800/50 p-3 rounded-lg border border-slate-700 space-y-3 text-xs animate-in" },
                React.createElement('div', {},
                    React.createElement('div', { className: "flex justify-between items-center font-bold text-slate-300 border-b border-slate-700 pb-1 mb-2" },
                        React.createElement('span', {}, "Simulation Série Complète"),
                        React.createElement('span', { className: formData.type === 'income' ? 'text-emerald-400' : 'text-rose-400' }, isSplit ? `${splitCount} x` : '1 x')
                    ),
                    isSplit && React.createElement('div', { className: "bg-indigo-900/30 p-1.5 rounded text-indigo-300 text-center mb-2 font-medium" },
                        `Mensualité : ${formatEuroDec(monthlyGross)} / mois`
                    ),
                    React.createElement('div', { className: "grid grid-cols-2 gap-x-4 gap-y-1" },
                        formData.type === 'income' && React.createElement(React.Fragment, {},
                            React.createElement('div', { className: "flex justify-between text-slate-500" }, "Commissions (Tot.)", React.createElement('span', { className: "text-slate-400" }, formatEuroDec(totalComm))),
                            React.createElement('div', { className: "flex justify-between text-slate-500" }, "TVA + URSSAF", React.createElement('span', { className: "text-orange-400" }, formatEuroDec(totalTax))),
                            React.createElement('div', { className: "flex justify-between text-slate-300 font-medium border-t border-slate-700/50 mt-1 pt-1 col-span-2" }, 
                                "Net Poche Total (Série)", 
                                React.createElement('span', { className: "text-emerald-400 font-bold" }, formatEuroDec(netPocket))
                            )
                        ),
                         formData.type === 'expense' && React.createElement(React.Fragment, {},
                            React.createElement('div', { className: "flex justify-between text-slate-500" }, "TVA Récup.", React.createElement('span', { className: "text-emerald-400" }, formatEuroDec(tvaAmount))),
                            React.createElement('div', { className: "flex justify-between text-slate-300 font-medium border-t border-slate-700/50 mt-1 pt-1 col-span-2" }, 
                                "Coût Réel Total", 
                                React.createElement('span', { className: "text-rose-400 font-bold" }, formatEuroDec(totalAmt - tvaAmount))
                            )
                        )
                    )
                ),
                remainingGroupStats && React.createElement('div', { className: "pt-2 border-t border-slate-600" },
                    React.createElement('div', { className: "flex items-center gap-2 font-bold text-indigo-300 mb-1" },
                        React.createElement(History, { size: 12 }),
                        React.createElement('span', {}, `Reste série (depuis cette ligne)`)
                    ),
                    React.createElement('div', { className: "bg-indigo-900/20 rounded p-2" },
                        React.createElement('div', { className: "flex justify-between text-slate-400 mb-1" },
                            React.createElement('span', {}, `Nb. échéances restantes :`),
                            React.createElement('span', { className: "text-white" }, remainingGroupStats.count)
                        ),
                        React.createElement('div', { className: "flex justify-between text-slate-400 mb-1" },
                            React.createElement('span', {}, `Total Brut restant :`),
                            React.createElement('span', { className: "text-white" }, formatEuroDec(remainingGroupStats.gross))
                        ),
                        React.createElement('div', { className: "flex justify-between font-bold text-emerald-400 border-t border-indigo-500/30 pt-1" },
                            React.createElement('span', {}, `Total Net Poche restant :`),
                            React.createElement('span', {}, formatEuroDec(remainingGroupStats.net))
                        )
                    )
                )
            );
        };

        // --- APP ---
        const App = () => {
            const [user, setUser] = useState(null);
            const [loadingAuth, setLoadingAuth] = useState(true);
            const [isAuthorized, setIsAuthorized] = useState(false); 
            const [syncStatus, setSyncStatus] = useState('idle');
            const [transactions, setTransactions] = useState([]);
            const [settings, setSettings] = useState({ defaultUrssafRate: 22.0, defaultTvaRate: 20.0, history: {}, targetSalary: 3000 });
            const [viewMode, setViewMode] = useState('month'); 
            const [currentDate, setCurrentDate] = useState(new Date());
            const [isSettingsOpen, setIsSettingsOpen] = useState(false);
            const [isDocOpen, setIsDocOpen] = useState(false); 
            const [filterMode, setFilterMode] = useState('default'); 
            const [editingId, setEditingId] = useState(null);
            const [simulatedSalary, setSimulatedSalary] = useState(3000); 
            const [simulationDuration, setSimulationDuration] = useState(2);
            const [isSimulationEnabled, setIsSimulationEnabled] = useState(false); 
            
            const INITIAL_FORM = {
                title: '', amount: '', commission: '', type: 'income', date: new Date().toISOString().split('T')[0],
                category: 'Vente GIA', hasTvaIncome: false, customTvaRateIncome: 20,
                hasUrssaf: true, customUrssafRate: 22, hasTvaExpense: false, customTvaRateExpense: 20,
                adjUrssaf: 0, adjTva: 0, hasAdjUrssaf: false, hasAdjTva: false,
                isRecurring: false, recurrenceMonths: 12, isSplitPayment: false, splitCount: 3,
                isValidated: true
            };

            const [formData, setFormData] = useState(INITIAL_FORM);
            const updateTimeoutRef = useRef(null);
            const saveSettingsTimeoutRef = useRef(null);

            useEffect(() => {
                const unsubscribe = onAuthStateChanged(auth, (u) => { setUser(u); if (u) setIsAuthorized(u.email === ADMIN_EMAIL); setLoadingAuth(false); });
                return () => unsubscribe();
            }, []);

            useEffect(() => {
                if (!user || !isAuthorized) return;
                const q = query(collection(db, 'artifacts', appId, 'users', user.uid, 'transactions'));
                const unsubTx = onSnapshot(q, (snap) => setTransactions(snap.docs.map(d => ({ id: d.id, ...d.data() }))));
                const unsubSet = onSnapshot(doc(db, 'artifacts', appId, 'users', user.uid, 'settings', 'global'), (snap) => {
                    if (snap.exists()) {
                        const s = snap.data();
                        setSettings(prev => ({...prev, ...s}));
                        if(!editingId) setFormData(p => ({...p, customUrssafRate: s.defaultUrssafRate || 22, customTvaRateIncome: s.defaultTvaRate || 20, customTvaRateExpense: s.defaultTvaRate || 20}));
                        
                        if (s.simulatedSalary) setSimulatedSalary(parseFloat(s.simulatedSalary));
                        if (s.simulationDuration) setSimulationDuration(parseInt(s.simulationDuration));
                    }
                });
                return () => { unsubTx(); unsubSet(); };
            }, [user, isAuthorized, editingId]);

            const handleLogin = async () => { await signInWithPopup(auth, new GoogleAuthProvider()); };
            const handleLogout = () => signOut(auth);
            const saveTx = async (tx) => { setSyncStatus('syncing'); try { await setDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'transactions', String(tx.id)), tx); setSyncStatus('saved'); setTimeout(() => setSyncStatus('idle'), 2000); } catch (e) { setSyncStatus('error'); } };
            const deleteTx = async (id) => { if(confirm("Supprimer cette opération ?")) { try { await deleteDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'transactions', String(id))); resetForm(); } catch (e) {} } };
            const saveSettings = async (s) => { try { await setDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'settings', 'global'), s, { merge: true }); } catch (e) {} };
            
            const handleSettingsChange = (newValues) => {
                if (saveSettingsTimeoutRef.current) clearTimeout(saveSettingsTimeoutRef.current);
                saveSettingsTimeoutRef.current = setTimeout(() => {
                     const updatedSettings = { ...settings, ...newValues };
                     setSettings(updatedSettings);
                     saveSettings(updatedSettings);
                }, 800);
            };

            const resetForm = () => {
                setEditingId(null);
                setFormData({...INITIAL_FORM, customUrssafRate: settings.defaultUrssafRate, customTvaRateIncome: settings.defaultTvaRate, customTvaRateExpense: settings.defaultTvaRate});
            };
            
            const handleEditClick = (tx) => {
                setEditingId(tx.id);
                let groupCount = 1; let isSplit = false; let isRecurring = false;
                if (tx.groupId) {
                    const groupMembers = transactions.filter(t => t.groupId === tx.groupId);
                    groupCount = groupMembers.length;
                    if (groupCount > 1) { if (tx.type === 'income') isSplit = true; if (tx.type === 'expense') isRecurring = true; }
                }
                const isIncome = tx.type === 'income'; const isExpense = tx.type === 'expense';
                setFormData({
                    title: tx.title, amount: tx.amount, commission: tx.commission, type: tx.type, date: tx.date, category: tx.category || '',
                    hasUrssaf: tx.urssafRate > 0, customUrssafRate: tx.urssafRate || settings.defaultUrssafRate,
                    hasTvaIncome: isIncome && tx.tvaRate > 0, customTvaRateIncome: isIncome ? (tx.tvaRate || settings.defaultTvaRate) : settings.defaultTvaRate,
                    hasTvaExpense: isExpense && tx.tvaRate > 0, customTvaRateExpense: isExpense ? (tx.tvaRate || settings.defaultTvaRate) : settings.defaultTvaRate,
                    adjUrssaf: tx.adjUrssaf || 0, adjTva: tx.adjTva || 0, hasAdjUrssaf: tx.adjUrssaf !== 0, hasAdjTva: tx.adjTva !== 0,
                    isSplitPayment: isSplit, splitCount: isSplit ? groupCount : 3, isRecurring: isRecurring, recurrenceMonths: isRecurring ? groupCount : 12, isValidated: tx.validated
                });
            };

            const handleFormSubmit = async (e) => { 
                e.preventDefault(); if (!formData.title) return; 
                const baseAmount = parseFloat(formData.amount || 0); const baseCommission = parseFloat(formData.commission || 0); const baseDate = new Date(formData.date); 
                let rates = { tva: 0, urssaf: 0, adjU: 0, adjT: 0 }; 
                if (formData.type === 'income') { if(formData.hasTvaIncome) rates.tva = parseFloat(formData.customTvaRateIncome); if(formData.hasUrssaf) rates.urssaf = parseFloat(formData.customUrssafRate); } 
                else if (formData.type === 'expense' && formData.hasTvaExpense) { rates.tva = parseFloat(formData.customTvaRateExpense); } 
                else if (formData.type === 'adjustment') { if(formData.hasAdjUrssaf) rates.adjU = parseFloat(formData.adjUrssaf || 0); if(formData.hasAdjTva) rates.adjT = parseFloat(formData.adjTva || 0); } 
                
                if (editingId) {
                    const originalTx = transactions.find(t => t.id === editingId);
                    const updatedTx = { ...originalTx, title: formData.title, amount: baseAmount, commission: baseCommission, type: formData.type, date: formData.date, tvaRate: rates.tva, urssafRate: rates.urssaf, adjUrssaf: rates.adjU, adjTva: rates.adjT, validated: formData.date > new Date().toISOString().split('T')[0] ? false : formData.isValidated };
                    if (originalTx.groupId && originalTx.date !== formData.date) {
                        const oldD = new Date(originalTx.date); const newD = new Date(formData.date); const diffTime = newD.getTime() - oldD.getTime(); const diffDays = diffTime / (1000 * 3600 * 24);
                        const groupTxs = transactions.filter(t => t.groupId === originalTx.groupId && t.id !== editingId);
                        groupTxs.forEach(sibling => { const sDate = new Date(sibling.date); sDate.setDate(sDate.getDate() + diffDays); saveTx({ ...sibling, date: sDate.toISOString().split('T')[0] }); });
                    }
                    await saveTx(updatedTx); resetForm(); return;
                }

                const groupId = (formData.isSplitPayment || formData.isRecurring) ? Date.now().toString() : null;
                const createTx = (offset, date, suffix = '', amt = null, comm = null, validated = true) => ({ id: Date.now() + offset, groupId: groupId, title: formData.title + suffix, amount: amt !== null ? amt : baseAmount, commission: comm !== null ? comm : baseCommission, type: formData.type, category: formData.category, date: date, tvaRate: rates.tva, urssafRate: rates.urssaf, adjUrssaf: rates.adjU, adjTva: rates.adjT, validated: validated }); 
                const newTxs = []; const today = new Date().toISOString().split('T')[0];
                
                if (formData.type === 'income' && formData.isSplitPayment) { for(let i=0; i<formData.splitCount; i++) { const d = new Date(baseDate); d.setMonth(baseDate.getMonth() + i); const dStr = d.toISOString().split('T')[0]; const isValid = (i === 0 && dStr <= today) ? true : false; newTxs.push(createTx(i, dStr, ` (${i+1}/${formData.splitCount})`, null, null, isValid)); } } 
                else if (formData.type === 'expense' && formData.isRecurring) { for(let i=0; i<formData.recurrenceMonths; i++) { const d = new Date(baseDate); d.setMonth(baseDate.getMonth() + i); const dStr = d.toISOString().split('T')[0]; const isValid = (i === 0 && dStr <= today) ? true : false; newTxs.push(createTx(i, dStr, '', null, null, isValid)); } } 
                else { const isValid = (formData.date <= today) ? true : false; newTxs.push(createTx(0, formData.date, '', null, null, isValid)); } 
                newTxs.forEach(saveTx); resetForm();
            };
            
            const handleQuickValidate = (id, currentVal) => {
                const tx = transactions.find(t => t.id === id);
                if(tx) saveTx({...tx, validated: !currentVal});
            };

            const calculateLineTax = (t) => { 
                const amt = parseFloat(t.amount || 0); 
                const comm = parseFloat(t.commission || 0);
                if(t.type === 'adjustment') return { net: amt - (t.adjUrssaf||0), urssaf: t.adjUrssaf||0, tvaNet: t.adjTva||0, bank: amt }; 
                if(t.type === 'income') { 
                    let ht = amt, tva = 0, urssaf = 0; 
                    if(t.tvaRate > 0) { ht = amt / (1 + t.tvaRate/100); tva = amt - ht; } 
                    if(t.urssafRate > 0) urssaf = ht * (t.urssafRate/100); 
                    const net = ht - urssaf - comm; const bank = amt - comm;
                    return { net, urssaf, tvaNet: tva, bank }; 
                } else { 
                    let ht = amt, tva = 0; 
                    if(t.tvaRate > 0) { ht = amt / (1 + t.tvaRate/100); tva = amt - ht; } 
                    return { net: 0, urssaf: 0, tvaNet: -tva, bank: -amt }; 
                } 
            };

            const stats = useMemo(() => { 
                let currentNetPocket = 0, futureNetPocket = 0, nextMonthNetPocket = 0, globalProjected = 0, totalTaxLiability = 0, urssafLiability = 0, tvaLiability = 0, currentBank = 0;
                const todayStr = new Date().toISOString().split('T')[0];
                const nextMonthDate = new Date(); nextMonthDate.setDate(nextMonthDate.getDate() + 30);
                const nextMonthStr = nextMonthDate.toISOString().split('T')[0];
                const alerts = transactions.filter(t => !t.validated && t.date <= todayStr).sort((a,b) => new Date(a.date) - new Date(b.date));
                
                let totalProjectedExpense = 0;
                
                const sortedTxs = [...transactions].sort((a, b) => new Date(a.date) - new Date(b.date));
                let runningBank = 0;
                let minProjectedUntilPayday = Infinity;

                const today = new Date();
                let payDate = new Date(today.getFullYear(), today.getMonth(), 26);
                if (today.getDate() >= 26) {
                    payDate.setMonth(payDate.getMonth() + 1);
                }
                const nextPayDateStr = payDate.toISOString().split('T')[0];
                
                // Projection 30 days for expenses
                const thirtyDaysLater = new Date(today);
                thirtyDaysLater.setDate(thirtyDaysLater.getDate() + 30);
                const thirtyDaysStr = thirtyDaysLater.toISOString().split('T')[0];

                transactions.forEach(t => {
                    const tax = calculateLineTax(t);
                    if (t.validated) {
                         runningBank += tax.bank;
                         currentBank += tax.bank;
                    }
                });
                minProjectedUntilPayday = runningBank; 
                sortedTxs.forEach(t => {
                    if (!t.validated && t.date >= todayStr && t.date <= nextPayDateStr) {
                        const tax = calculateLineTax(t);
                        runningBank += tax.bank;
                        if (runningBank < minProjectedUntilPayday) minProjectedUntilPayday = runningBank;
                    }
                    
                    // Calculate projected expenses for next 30 days
                    if (t.type === 'expense' && t.date >= todayStr && t.date <= thirtyDaysStr) {
                         // Use HT cost for Net Pocket impact
                         const tax = calculateLineTax(t);
                         totalProjectedExpense += Math.abs(tax.bank - tax.tvaNet);
                    }
                });

                transactions.forEach(t => { 
                    const tax = calculateLineTax(t);
                    if (t.validated) {
                         totalTaxLiability += (tax.urssaf + tax.tvaNet); 
                         urssafLiability += tax.urssaf; 
                         tvaLiability += tax.tvaNet;
                    }
                    if(t.type === 'income' || t.type === 'adjustment') globalProjected += tax.net; else globalProjected += tax.bank;
                    if (t.validated) { 
                        if(t.type === 'income' || t.type === 'adjustment') currentNetPocket += tax.net; else currentNetPocket += tax.bank; 
                    } else {
                        if(t.type === 'income') { futureNetPocket += tax.net; if (t.date <= nextMonthStr) nextMonthNetPocket += tax.net; }
                    }
                }); 
                
                // Monthly projected expense (HT)
                const projectedMonthlyExpenses = totalProjectedExpense;

                return { currentNetPocket, futureNetPocket, nextMonthNetPocket, globalProjected, alerts, totalTaxLiability, urssafLiability, tvaLiability, currentBank, projectedMonthlyExpenses, minProjectedUntilPayday }; 
            }, [transactions]);
            
            // ... (chartData, filteredTxs, quarterlyData, getListTitle unchanged) ...
            const chartData = useMemo(() => { 
                const grouped = {}; transactions.forEach(t => { if(!grouped[t.date]) grouped[t.date]=[]; grouped[t.date].push(t); }); 
                const today = new Date();
                const todayStr = today.toISOString().split('T')[0];

                let startDate, endDate;
                if (viewMode === 'month') { 
                    startDate = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1); 
                    endDate = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0); 
                } else if (viewMode === 'year') { 
                    startDate = new Date(currentDate.getFullYear(), 0, 1); 
                    endDate = new Date(currentDate.getFullYear(), 11, 31); 
                }

                const allDates = []; 
                if (startDate && endDate) { 
                    for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) { allDates.push(new Date(d).toISOString().split('T')[0]); } 
                } else { 
                    const txDates = Object.keys(grouped).sort();
                    if (txDates.length > 0) {
                        const minStr = txDates[0];
                        let maxStr = txDates[txDates.length - 1];
                        if (isSimulationEnabled) {
                            const future = new Date(); future.setMonth(future.getMonth() + simulationDuration + 1); const futureStr = future.toISOString().split('T')[0]; if (futureStr > maxStr) maxStr = futureStr;
                        }
                        const d = new Date(minStr); const end = new Date(maxStr); while (d <= end) { allDates.push(d.toISOString().split('T')[0]); d.setDate(d.getDate() + 1); }
                    }
                }
                
                const relevantDates = [...new Set([...allDates, ...Object.keys(grouped)])].sort();
                let running = 0; let salaryDeductionAcc = 0; 
                
                const simLimitDate = new Date(today);
                simLimitDate.setMonth(simLimitDate.getMonth() + simulationDuration);
                const simLimitStr = simLimitDate.toISOString().split('T')[0];

                return relevantDates.reduce((acc, dateStr) => { 
                    const dDate = new Date(dateStr);
                    if (grouped[dateStr]) { grouped[dateStr].forEach(t => { running += calculateLineTax(t).bank; }); }
                    
                    let isPayDay = false;
                    if (isSimulationEnabled && dateStr <= simLimitStr && dDate.getDate() === 26 && dateStr > todayStr) { 
                         salaryDeductionAcc += simulatedSalary; 
                         isPayDay = true; 
                    }

                    let isInView = true;
                    if (viewMode === 'month' && (dDate.getMonth() !== currentDate.getMonth() || dDate.getFullYear() !== currentDate.getFullYear())) isInView = false;
                    if (viewMode === 'year' && dDate.getFullYear() !== currentDate.getFullYear()) isInView = false;

                    if (isInView) {
                        acc.push({ 
                            date: new Date(dateStr).toLocaleDateString('fr-FR', {day:'numeric', month:'short'}), 
                            fullDate: dateStr, 
                            solde: running, 
                            soldeReel: dateStr <= todayStr ? running : null, 
                            soldeProj: running,
                            soldeWithSalary: (isSimulationEnabled && dateStr > todayStr) ? running - salaryDeductionAcc : null,
                            isPayDay: isPayDay
                        }); 
                    }
                    return acc; 
                }, []); 
            }, [transactions, viewMode, currentDate, simulatedSalary, isSimulationEnabled, simulationDuration]);
            
            const filteredTxs = useMemo(() => { 
                const nextMonthDate = new Date(); nextMonthDate.setDate(nextMonthDate.getDate() + 30); const nextMonthStr = nextMonthDate.toISOString().split('T')[0];
                if (filterMode === 'future_30') return transactions.filter(t => !t.validated && t.type === 'income' && t.date <= nextMonthStr).sort((a,b) => new Date(a.date) - new Date(b.date));
                if (filterMode === 'future_total') return transactions.filter(t => !t.validated && t.type === 'income').sort((a,b) => new Date(a.date) - new Date(b.date));
                if (filterMode === 'default') return transactions.filter(t => { const d = new Date(t.date); if (viewMode === 'month') return d.getMonth() === currentDate.getMonth() && d.getFullYear() === currentDate.getFullYear(); if (viewMode === 'year') return d.getFullYear() === currentDate.getFullYear(); return true; }).sort((a,b) => new Date(b.date) - new Date(a.date)); 
                return [];
            }, [transactions, currentDate, viewMode, filterMode]);
            
            const quarterlyData = useMemo(() => {
                const quarters = []; let minYear = 2023, maxYear = new Date().getFullYear() + 1;
                if (transactions.length > 0) { const years = transactions.map(t => new Date(t.date).getFullYear()); minYear = Math.min(minYear, ...years); maxYear = Math.max(maxYear, ...years); }
                for (let y = minYear; y <= maxYear; y++) {
                    for (let q = 1; q <= 4; q++) {
                        const key = `${y}-${q}`; const manualVal = (settings.history && settings.history[key]) ? parseFloat(settings.history[key]) : 0; let realVal = 0;
                        transactions.forEach(t => { if (t.type === 'income') { const d = new Date(t.date); if (Math.floor(d.getMonth() / 3) + 1 === q && d.getFullYear() === y && d >= new Date('2025-10-01')) realVal += parseFloat(t.amount || 0); } });
                        if (manualVal > 0 || realVal > 0 || (y === new Date().getFullYear())) quarters.push({ name: `T${q} ${y}`, ca: manualVal > 0 ? manualVal : realVal, type: manualVal > 0 ? 'Manuel' : 'Réel' });
                    }
                }
                return quarters;
            }, [settings.history, transactions]);

            const getListTitle = () => {
                if (filterMode === 'future_30') return "Encaissements à venir (30j)";
                if (filterMode === 'future_total') return "Tous les encaissements futurs";
                return `Historique (${viewMode === 'month' ? currentDate.toLocaleDateString('fr-FR', {month:'long'}) : currentDate.getFullYear()})`;
            };

            if (loadingAuth) return React.createElement(Loader2, { size: 48, className: "animate-spin m-auto text-indigo-400" });
            if (!user) return React.createElement(LoginScreen, { onLogin: handleLogin, loading: false });
            if (user && !isAuthorized) return React.createElement(UnauthorizedScreen, { onLogout: handleLogout, email: user.email });

            const todayLabel = new Date().toLocaleDateString('fr-FR', {day:'numeric', month:'short'});

            return React.createElement('div', { className: "min-h-screen bg-slate-950 text-slate-300 font-sans p-4 pb-28 md:p-6" },
                React.createElement('div', { className: "max-w-7xl mx-auto space-y-4" },
                    isDocOpen && React.createElement(DocumentationModal, { onClose: () => setIsDocOpen(false) }),
                    stats.alerts.length > 0 && React.createElement('div', { className: "bg-orange-900/30 border border-orange-500/50 rounded-lg p-4 mb-2 animate-in" },
                        React.createElement('div', { className: "flex items-center justify-between mb-2" },
                            React.createElement('h3', { className: "text-orange-400 font-bold flex items-center gap-2" }, React.createElement(AlertTriangle, { size: 20 }), `Action Requise : ${stats.alerts.length} opération(s)`),
                            React.createElement('span', { className: "text-xs text-orange-300/70" }, "Confirme l'encaissement réel")
                        ),
                        React.createElement('div', { className: "space-y-2 max-h-40 overflow-y-auto pr-2" },
                            stats.alerts.map(t => React.createElement('div', { key: t.id, className: "flex items-center justify-between bg-slate-900/50 p-2 rounded border border-orange-500/20" },
                                React.createElement('div', { className: "flex items-center gap-3" }, React.createElement('span', { className: "text-xs font-mono text-slate-400" }, new Date(t.date).toLocaleDateString('fr-FR')), React.createElement('span', { className: "text-sm text-white font-medium" }, t.title), React.createElement('span', { className: `text-xs font-bold ${t.type==='income'?'text-emerald-400':'text-rose-400'}` }, formatEuro(t.amount))),
                                React.createElement(Button, { variant: "success", onClick: () => handleQuickValidate(t.id, false), className: "!py-1 !px-2 !text-xs" }, React.createElement(Check, { size: 12, className: "mr-1" }), "Valider")
                            ))
                        )
                    ),
                    React.createElement('div', { className: "flex justify-between items-center" },
                        React.createElement('h1', { className: "text-xl font-bold text-white flex items-center gap-2" }, React.createElement(Wallet, { className: "text-indigo-400", size: 24 }), "Pilote GIA"),
                        React.createElement('div', { className: "flex items-center gap-2" },
                            React.createElement('span', { className: "hidden sm:flex items-center gap-1 px-2 py-1 bg-emerald-900/30 text-emerald-400 text-[10px] uppercase tracking-wider rounded border border-emerald-900/50" }, React.createElement(ShieldCheck, { size: 12 }), "Admin"),
                            syncStatus === 'syncing' && React.createElement(Loader2, { size: 14, className: "animate-spin text-indigo-400" }),
                            syncStatus === 'saved' && React.createElement(CheckCircle, { size: 14, className: "text-emerald-500" }),
                            React.createElement(Button, { variant: "secondary", onClick: () => setIsDocOpen(true), className: "!p-2" }, React.createElement(BookOpen, { size: 16 })),
                            React.createElement(Button, { variant: "secondary", onClick: () => setIsSettingsOpen(!isSettingsOpen), className: "!p-2" }, React.createElement(Settings, { size: 16 })),
                            React.createElement('div', { className: "flex bg-slate-900 p-1 rounded-lg border border-slate-800" },
                                React.createElement('button', { onClick: () => setViewMode('month'), className: `px-3 py-1 rounded text-xs font-bold ${viewMode==='month'?'bg-indigo-600 text-white':'text-slate-500'}` }, "Mois"),
                                React.createElement('button', { onClick: () => setViewMode('year'), className: `px-3 py-1 rounded text-xs font-bold ${viewMode==='year'?'bg-indigo-600 text-white':'text-slate-500'}` }, "Année"),
                                React.createElement('button', { onClick: () => setViewMode('max'), className: `px-3 py-1 rounded text-xs font-bold ${viewMode==='max'?'bg-indigo-600 text-white':'text-slate-500'}` }, "Max")
                            ),
                            React.createElement(Button, { variant: "danger", onClick: handleLogout, className: "!p-2" }, React.createElement(LogOut, { size: 16 }))
                        )
                    ),
                    isSettingsOpen && React.createElement('div', { className: "bg-slate-900 p-4 rounded-xl border border-indigo-900/50 shadow-lg space-y-4 text-sm" },
                        React.createElement('div', { className: "grid grid-cols-3 gap-4" },
                            React.createElement('div', {}, React.createElement('label', { className: "text-xs text-slate-400" }, "Taux URSSAF %"), React.createElement('input', { type: "number", value: settings.defaultUrssafRate, onChange: e => { const v=e.target.value; setSettings(p=>({...p, defaultUrssafRate:v})); saveSettings({...settings, defaultUrssafRate:v}); }, className: "w-full bg-slate-950 border border-slate-700 rounded p-1 text-white" })),
                            React.createElement('div', {}, React.createElement('label', { className: "text-xs text-slate-400" }, "Taux TVA %"), React.createElement('input', { type: "number", value: settings.defaultTvaRate, onChange: e => { const v=e.target.value; setSettings(p=>({...p, defaultTvaRate:v})); saveSettings({...settings, defaultTvaRate:v}); }, className: "w-full bg-slate-950 border border-slate-700 rounded p-1 text-white" })),
                            React.createElement('div', {}, React.createElement('label', { className: "text-xs text-emerald-400 font-bold" }, "Salaire Cible €"), React.createElement('input', { type: "number", value: settings.targetSalary, onChange: e => { const v=e.target.value; setSettings(p=>({...p, targetSalary:v})); saveSettings({...settings, targetSalary:v}); }, className: "w-full bg-slate-950 border border-emerald-800 rounded p-1 text-white" }))
                        ),
                        React.createElement('div', {}, 
                            React.createElement('div', { className: "text-white font-bold border-b border-slate-800 pb-1 mb-2" }, "Historique CA (Manuel)"),
                            React.createElement('div', { className: "grid grid-cols-4 gap-2" }, [2023, 2024, 2025].map(year => [1, 2, 3, 4].map(q => { const key = `${year}-${q}`; return React.createElement('div', { key: key }, React.createElement('label', { className: "text-[10px] text-indigo-400 font-bold" }, `T${q} ${year}`), React.createElement('input', { type: "number", value: (settings.history && settings.history[key]) || '', placeholder: "0", onChange: e => { const newHistory = { ...(settings.history || {}), [key]: e.target.value }; setSettings(p => ({...p, history: newHistory})); saveSettings({...settings, history: newHistory}); }, className: "w-full bg-slate-800 border border-slate-700 rounded p-1 text-xs text-white outline-none" }) ); })))
                        )
                    ),
                    React.createElement('div', { className: "grid grid-cols-1 lg:grid-cols-12 gap-6" },
                        React.createElement('div', { className: "lg:col-span-8 space-y-4 flex flex-col" },
                            React.createElement(RemunerationAdvisor, { stats, settings, transactions, simulatedSalary, setSimulatedSalary, simulationDuration, setSimulationDuration, isSimulationEnabled, setIsSimulationEnabled, onSettingsChange: handleSettingsChange }),
                            React.createElement('div', { className: "grid grid-cols-2 md:grid-cols-5 gap-3" },
                                React.createElement(Card, { onClick: () => setFilterMode('default'), className: `p-3 border-l-4 cursor-pointer transition-all hover:shadow-lg ${filterMode === 'default' ? 'border-l-emerald-400 bg-slate-800 ring-1 ring-emerald-500' : 'border-l-slate-500'}` }, React.createElement('div', { className: "text-slate-400 text-[10px] uppercase font-bold" }, "Net Actuel (Dispo)"), React.createElement('div', { className: "text-xl font-bold text-white" }, formatEuro(stats.currentNetPocket))),
                                React.createElement(Card, { onClick: () => setFilterMode('future_30'), className: `p-3 border-l-4 cursor-pointer transition-all hover:shadow-lg ${filterMode === 'future_30' ? 'border-l-indigo-400 bg-slate-800 ring-1 ring-indigo-500' : 'border-l-indigo-500'}` }, React.createElement('div', { className: "text-indigo-400 text-[10px] uppercase font-bold flex items-center gap-1" }, React.createElement(CalendarClock, {size:12}), "Net à venir (30j)"), React.createElement('div', { className: "text-xl font-bold text-indigo-500" }, formatEuro(stats.nextMonthNetPocket))),
                                React.createElement(Card, { onClick: () => setFilterMode('future_total'), className: `p-3 border-l-4 cursor-pointer transition-all hover:shadow-lg ${filterMode === 'future_total' ? 'border-l-indigo-300 bg-slate-800 ring-1 ring-indigo-400' : 'border-l-indigo-900'}` }, React.createElement('div', { className: "text-indigo-300 text-[10px] uppercase font-bold flex items-center gap-1" }, "Net à venir (Total)"), React.createElement('div', { className: "text-xl font-bold text-indigo-300" }, formatEuro(stats.futureNetPocket))),
                                React.createElement(Card, { className: "p-3 border-l-4 border-l-purple-500 bg-purple-900/10" }, React.createElement('div', { className: "text-purple-400 text-[10px] uppercase font-bold" }, "Tréso Globale (Net+Futur)"), React.createElement('div', { className: "text-xl font-bold text-purple-400" }, formatEuro(stats.currentNetPocket + stats.futureNetPocket))),
                                React.createElement(Card, { className: "p-3 border-l-4 border-l-orange-500 bg-orange-900/10" }, React.createElement('div', { className: "text-orange-400 text-[10px] uppercase font-bold flex items-center gap-1" }, React.createElement(PiggyBank, {size:12}), "Provisions Impôts"), React.createElement('div', { className: "text-xl font-bold text-orange-500" }, formatEuro(stats.totalTaxLiability)), React.createElement('div', { className: "flex flex-col text-[9px] text-orange-400/70 mt-1" }, React.createElement('span', {}, `TVA: ${formatEuro(Math.max(0, stats.tvaLiability))}`), React.createElement('span', {}, `URSSAF: ${formatEuro(stats.urssafLiability)}`)))
                            ),
                            React.createElement(Card, { className: "p-4 h-64" },
                                React.createElement('div', { className: "flex justify-between mb-2" }, 
                                    React.createElement('h3', { className: "font-bold text-slate-200 text-sm" }, "Projection Trésorerie (Compte Banque)"),
                                    viewMode === 'month' && React.createElement('div', { className: "flex items-center gap-2 text-xs bg-slate-950 px-2 py-0.5 rounded-full" }, React.createElement('button', { onClick: () => setCurrentDate(new Date(currentDate.setMonth(currentDate.getMonth()-1))) }, "←"), React.createElement('span', { className: "w-20 text-center" }, currentDate.toLocaleDateString('fr-FR', {month:'long', year:'numeric'})), React.createElement('button', { onClick: () => setCurrentDate(new Date(currentDate.setMonth(currentDate.getMonth()+1))) }, "→") )
                                ),
                                React.createElement(ResponsiveContainer, { width: "100%", height: "85%" },
                                    React.createElement(ComposedChart, { data: chartData },
                                        React.createElement("defs", null, React.createElement("linearGradient", { id: "colorSolde", x1: "0", y1: "0", x2: "0", y2: "1" }, React.createElement("stop", { offset: "5%", stopColor: "#6366f1", stopOpacity: 0.3 }), React.createElement("stop", { offset: "95%", stopColor: "#6366f1", stopOpacity: 0 }))),
                                        React.createElement(CartesianGrid, { strokeDasharray: "3 3", vertical: false, stroke: "#334155" }),
                                        React.createElement(XAxis, { dataKey: "date", axisLine: false, tickLine: false, tick: { fill: '#64748b', fontSize: 10 }, minTickGap: 30 }),
                                        React.createElement(YAxis, { axisLine: false, tickLine: false, tick: { fill: '#64748b', fontSize: 10 } }),
                                        // ZONE ROUGE EN BAS (DANGER)
                                        React.createElement(ReferenceArea, { y1: -20000, y2: 0, fill: "rgba(225, 29, 72, 0.15)", stroke: "none" }),
                                        
                                        React.createElement(Tooltip, { contentStyle: { backgroundColor: '#1e293b', border: '1px solid #334155', color: '#fff', fontSize: '12px' }, formatter: (value, name) => [formatEuroDec(value), name === 'soldeWithSalary' ? 'Solde (Simulé)' : 'Solde'] }),
                                        React.createElement(ReferenceLine, { y: 0, stroke: "#94a3b8", strokeDasharray: "3 3", strokeWidth: 2 }),
                                        React.createElement(ReferenceLine, { x: todayLabel, stroke: "#fbbf24", strokeDasharray: "3 3", label: { value: "Aujourd'hui", fill: "#fbbf24", fontSize: 10, position: 'insideTopRight' } }),
                                        React.createElement(Area, { type: "monotone", dataKey: "soldeProj", stroke: "#818cf8", strokeWidth: 2, strokeDasharray: "5 5", fill: "url(#colorSolde)", fillOpacity: 0.3 }),
                                        React.createElement(Area, { type: "monotone", dataKey: "soldeReel", stroke: "#6366f1", strokeWidth: 3, fill: "url(#colorSolde)" }),
                                        // Simulation Line
                                        React.createElement(Line, { type: "monotone", dataKey: "soldeWithSalary", stroke: "#f97316", strokeWidth: 2, strokeDasharray: "4 4", dot: React.createElement(CustomSalaryDot), activeDot: { r: 6, stroke: "white", strokeWidth: 2, fill: "#f97316" }, name: "Solde (Simulé)" })
                                    )
                                )
                            ),
                            React.createElement(Card, { className: "p-4 h-64" },
                                React.createElement('h3', { className: "font-bold text-slate-200 mb-2 text-sm flex items-center gap-2" }, React.createElement(BarChart3, { size: 16, className: "text-indigo-400" }), "CA Trimestriel"),
                                React.createElement(ResponsiveContainer, { width: "100%", height: "85%" },
                                    React.createElement(BarChart, { data: quarterlyData },
                                        React.createElement(CartesianGrid, { strokeDasharray: "3 3", vertical: false, stroke: "#334155" }),
                                        React.createElement(XAxis, { dataKey: "name", axisLine: false, tickLine: false, tick: { fill: '#64748b', fontSize: 10 } }),
                                        React.createElement(YAxis, { axisLine: false, tickLine: false, tick: { fill: '#64748b', fontSize: 10 } }),
                                        React.createElement(Tooltip, { 
                                            contentStyle: { backgroundColor: '#1e293b', border: '1px solid #334155', color: '#f8fafc', fontSize: '12px' }, 
                                            itemStyle: { color: '#f8fafc' },
                                            cursor: {fill: 'rgba(255,255,255,0.05)'}, 
                                            formatter: (value) => [formatEuroDec(value), "CA"] 
                                        }),
                                        React.createElement(Bar, { dataKey: "ca", radius: [4, 4, 0, 0] }, quarterlyData.map((entry, index) => React.createElement(Cell, { key: `cell-${index}`, fill: entry.type === 'Manuel' ? '#94a3b8' : '#8b5cf6' })) )
                                    )
                                )
                            ),
                            React.createElement(Card, { className: "flex-1 flex flex-col min-h-[500px]" },
                                React.createElement('div', { className: "p-3 border-b border-slate-800 bg-slate-800/50 flex justify-between items-center" },
                                    React.createElement('h3', { className: `font-bold text-sm flex items-center gap-2 ${filterMode !== 'default' ? 'text-indigo-400' : 'text-slate-200'}` }, filterMode !== 'default' && React.createElement(Filter, {size: 14}), getListTitle()),
                                    filterMode !== 'default' && React.createElement('button', { onClick: () => setFilterMode('default'), className: "text-xs flex items-center gap-1 text-slate-400 hover:text-white" }, React.createElement(XCircle, {size: 14}), "Effacer le filtre")
                                ),
                                React.createElement('div', { className: "flex-1 overflow-y-auto" },
                                    React.createElement('table', { className: "w-full text-xs text-left" },
                                        React.createElement('thead', { className: "text-slate-500 uppercase bg-slate-900 sticky top-0" }, React.createElement('tr', {}, React.createElement('th', { className: "px-2 py-2" }, "Date"), React.createElement('th', { className: "px-2 py-2" }, "Titre"), React.createElement('th', { className: "px-2 py-2 text-right" }, "Montant"), React.createElement('th', { className: "px-2 py-2 text-center" }, "Action"))),
                                        React.createElement('tbody', {}, filteredTxs.length > 0 ? filteredTxs.map(t => 
                                            React.createElement('tr', { key: t.id, className: `border-b border-slate-800 hover:bg-slate-800/50 ${editingId === t.id ? 'bg-indigo-900/20' : ''}` },
                                                React.createElement('td', { className: "px-2 py-2" }, React.createElement('span', { className: "text-slate-400 font-mono" }, new Date(t.date).toLocaleDateString('fr-FR'))),
                                                React.createElement('td', { className: "px-2 py-2 font-medium text-slate-300 truncate max-w-[100px]", title: t.title }, t.title),
                                                React.createElement('td', { className: `px-2 py-2 text-right font-bold ${t.type==='income'?'text-emerald-400':t.type==='expense'?'text-rose-400':'text-purple-400'}` }, React.createElement('span', {}, formatEuroDec(t.amount))),
                                                React.createElement('td', { className: "px-2 py-2 text-center flex justify-center gap-1" },
                                                    React.createElement('button', { onClick: () => handleQuickValidate(t.id, t.validated), className: t.validated ? "text-emerald-500" : "text-slate-600 hover:text-emerald-500", title: t.validated ? "Validé" : "En attente" }, React.createElement(CheckCircle, { size: 14 })),
                                                    React.createElement('button', { onClick: () => handleEditClick(t), className: "text-slate-500 hover:text-white", title: "Modifier" }, React.createElement(Pencil, { size: 14 }))
                                                )
                                            )
                                        ) : ( React.createElement('tr', {}, React.createElement('td', { colSpan: 4, className: "px-2 py-8 text-center text-slate-600 italic" }, "Aucune opération")) ))
                                    )
                                )
                            )
                        ),
                        // ...
                        React.createElement('div', { className: "lg:col-span-4 space-y-4" },
                            // ... (Formulaire inchangé) ...
                            React.createElement(Card, { className: `p-4 sticky top-4 border-t-4 ${editingId ? 'border-t-orange-500 shadow-orange-900/20' : 'border-t-indigo-600'}` },
                                React.createElement('div', { className: "flex justify-between items-center mb-4" },
                                    React.createElement('h2', { className: "font-bold text-lg text-white" }, editingId ? "Modification" : "Saisie Cloud"),
                                    editingId && React.createElement(Button, { variant: "secondary", onClick: resetForm, className: "!py-1 !px-2 !text-xs" }, React.createElement(Undo2, {size:14}), "Annuler")
                                ),
                                React.createElement(SimulationPanel, { formData, transactions, editingId }),
                                React.createElement('form', { onSubmit: handleFormSubmit, className: "space-y-3 mt-4" },
                                    React.createElement('div', { className: "flex p-1 bg-slate-950 border border-slate-800 rounded-lg" },
                                        ['income','expense','adjustment'].map(type => React.createElement('button', { key: type, type: "button", onClick: () => setFormData({...formData, type}), className: `flex-1 py-1.5 text-xs font-bold rounded ${formData.type===type ? (type==='income'?'bg-emerald-600 text-white':type==='expense'?'bg-rose-600 text-white':'bg-purple-600 text-white') : 'text-slate-500'}` }, type==='income'?'Entrée':type==='expense'?'Sortie':'Régul') )
                                    ),
                                    React.createElement('div', { className: "grid grid-cols-2 gap-2" },
                                        React.createElement('input', { type: "number", placeholder: "Montant TTC", value: formData.amount, onChange: e => setFormData({...formData, amount: e.target.value}), className: "w-full p-2 bg-slate-950 border border-slate-700 rounded text-white font-bold text-sm" }),
                                        React.createElement('input', { type: "date", value: formData.date, onChange: e => setFormData({...formData, date: e.target.value}), className: "w-full p-2 bg-slate-950 border border-slate-700 rounded text-white text-xs" })
                                    ),
                                    React.createElement('div', { className: "relative" },
                                        React.createElement('input', { type: "number", placeholder: "Dont Commission (€)", value: formData.commission, onChange: e => setFormData({...formData, commission: e.target.value}), className: "w-full p-2 bg-slate-950 border border-slate-700 rounded text-white text-xs" }),
                                        React.createElement(Banknote, { size: 12, className: "absolute right-2 top-2.5 text-slate-600" })
                                    ),
                                    React.createElement('input', { type: "text", placeholder: "Titre", value: formData.title, onChange: e => setFormData({...formData, title: e.target.value}), className: "w-full p-2 bg-slate-950 border border-slate-700 rounded text-white text-sm" }),
                                    (formData.type === 'income' || formData.type === 'expense') && React.createElement('div', { className: "bg-slate-950/50 p-2 rounded border border-slate-800 space-y-2" },
                                        formData.type === 'income' && React.createElement(React.Fragment, {},
                                            React.createElement('div', { className: "flex justify-between items-center text-xs" },
                                                React.createElement('label', { className: "flex items-center gap-1 cursor-pointer text-slate-400" }, React.createElement('input', { type: "checkbox", checked: formData.hasUrssaf, onChange: e => setFormData({...formData, hasUrssaf: e.target.checked}), className: "rounded bg-slate-800 border-slate-600" }), "URSSAF"),
                                                formData.hasUrssaf && React.createElement('input', { type: "number", value: formData.customUrssafRate, onChange: e => setFormData({...formData, customUrssafRate: e.target.value}), className: "w-10 bg-transparent text-right border-b border-slate-600" })
                                            ),
                                            React.createElement('div', { className: "flex justify-between items-center text-xs" },
                                                React.createElement('label', { className: "flex items-center gap-1 cursor-pointer text-slate-400" }, React.createElement('input', { type: "checkbox", checked: formData.hasTvaIncome, onChange: e => setFormData({...formData, hasTvaIncome: e.target.checked}), className: "rounded bg-slate-800 border-slate-600" }), "TVA"),
                                                formData.hasTvaIncome && React.createElement('input', { type: "number", value: formData.customTvaRateIncome, onChange: e => setFormData({...formData, customTvaRateIncome: e.target.value}), className: "w-10 bg-transparent text-right border-b border-slate-600" })
                                            ),
                                            !editingId && React.createElement('div', { className: "pt-1 border-t border-slate-800/50" },
                                                React.createElement('label', { className: "flex items-center gap-1 text-xs text-emerald-500 cursor-pointer" },
                                                    React.createElement('input', { type: "checkbox", checked: formData.isSplitPayment, onChange: e => setFormData({...formData, isSplitPayment: e.target.checked}), className: "rounded bg-slate-800 border-emerald-900", disabled: !!editingId }), 
                                                    "Paiement en plusieurs fois"
                                                ),
                                                formData.isSplitPayment && React.createElement('div', { className: "flex items-center gap-2 mt-1 pl-4" },
                                                    React.createElement('span', { className: "text-[10px] text-slate-500" }, "Nb mois:"),
                                                    React.createElement('input', { type: "number", min: "2", max: "12", value: formData.splitCount, onChange: e => setFormData({...formData, splitCount: parseInt(e.target.value)}), className: "w-10 bg-slate-900 border border-slate-700 rounded text-xs text-center", disabled: !!editingId })
                                                )
                                            )
                                        ),
                                        formData.type === 'expense' && React.createElement(React.Fragment, {},
                                            React.createElement('div', { className: "flex justify-between items-center text-xs" },
                                                React.createElement('label', { className: "flex items-center gap-1 cursor-pointer text-slate-400" }, React.createElement('input', { type: "checkbox", checked: formData.hasTvaExpense, onChange: e => setFormData({...formData, hasTvaExpense: e.target.checked}), className: "rounded bg-slate-800 border-slate-600" }), "TVA Récup."),
                                                formData.hasTvaExpense && React.createElement('input', { type: "number", value: formData.customTvaRateExpense, onChange: e => setFormData({...formData, customTvaRateExpense: e.target.value}), className: "w-10 bg-transparent text-right border-b border-slate-600" })
                                            ),
                                            !editingId && React.createElement('div', { className: "pt-1 border-t border-slate-800/50" },
                                                React.createElement('label', { className: "flex items-center gap-1 text-xs text-rose-500 cursor-pointer" },
                                                    React.createElement('input', { type: "checkbox", checked: formData.isRecurring, onChange: e => setFormData({...formData, isRecurring: e.target.checked}), className: "rounded bg-slate-800 border-rose-900", disabled: !!editingId }),
                                                    "Récurrent"
                                                ),
                                                formData.isRecurring && React.createElement('div', { className: "flex items-center gap-2 mt-1 pl-4" },
                                                    React.createElement('span', { className: "text-[10px] text-slate-500" }, "Mois:"),
                                                    React.createElement('input', { type: "number", min: "2", max: "24", value: formData.recurrenceMonths, onChange: e => setFormData({...formData, recurrenceMonths: parseInt(e.target.value)}), className: "w-10 bg-slate-900 border border-slate-700 rounded text-xs text-center", disabled: !!editingId })
                                                )
                                            )
                                        )
                                    ),
                                    (formData.type === 'adjustment') && React.createElement('div', { className: "bg-purple-900/20 p-2 rounded border border-purple-900/50 space-y-2 text-xs" },
                                        React.createElement('div', { className: "flex justify-between items-center" }, React.createElement('label', { className: "flex items-center gap-1 cursor-pointer text-slate-300" }, React.createElement('input', { type: "checkbox", checked: formData.hasAdjUrssaf, onChange: e => setFormData({...formData, hasAdjUrssaf: e.target.checked}), className: "rounded bg-slate-800 border-slate-600" }), "Régul URSSAF"), formData.hasAdjUrssaf && React.createElement('input', { type: "number", placeholder: "+/-", value: formData.adjUrssaf, onChange: e => setFormData({...formData, adjUrssaf: e.target.value}), className: "w-14 bg-slate-900 border border-slate-700 rounded px-1 text-right" }) ),
                                        React.createElement('div', { className: "flex justify-between items-center" }, React.createElement('label', { className: "flex items-center gap-1 cursor-pointer text-slate-300" }, React.createElement('input', { type: "checkbox", checked: formData.hasAdjTva, onChange: e => setFormData({...formData, hasAdjTva: e.target.checked}), className: "rounded bg-slate-800 border-slate-600" }), "Régul TVA"), formData.hasAdjTva && React.createElement('input', { type: "number", placeholder: "+/-", value: formData.adjTva, onChange: e => setFormData({...formData, adjTva: e.target.value}), className: "w-14 bg-slate-900 border border-slate-700 rounded px-1 text-right" }) )
                                    ),
                                    React.createElement('div', { className: "flex gap-2" },
                                        editingId && React.createElement(Button, { variant: "danger", onClick: () => deleteTx(editingId), className: "w-auto", title: "Supprimer" }, React.createElement(Trash2, {size:16})),
                                        React.createElement(Button, { type: "submit", variant: editingId ? "warning" : "primary", className: "w-full py-2", disabled: syncStatus === 'syncing' }, editingId ? "Modifier" : "Valider")
                                    )
                                )
                            )
                        )
                    )
                )
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(React.createElement(App));
    </script>
</body>
</html>
